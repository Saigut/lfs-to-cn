<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
    <title>
      6.10.&nbsp;调节工具链
    </title>
    <link rel="stylesheet" type="text/css" href="../stylesheets/lfs.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.78.1" />
    <link rel="stylesheet" href="stylesheets/lfs-print.css" type="text/css"
    media="print" />
  </head>
  <body class="lfs" id="lfs-7.5">
    <div class="navheader">
      <h4>
        Linux From Scratch - 版本 7.5
      </h4>
      <h3>
        第&nbsp;6&nbsp;章&nbsp;安装基本系统软件
      </h3>
      <ul>
        <li class="prev">
          <a accesskey="p" href="glibc.html" title="Glibc-2.19">上一页</a>
          <p>
            Glibc-2.19
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="zlib.html" title="Zlib-1.2.8">下一页</a>
          <p>
            Zlib-1.2.8
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter06.html" title=
          "第&nbsp;6&nbsp;章&nbsp;安装基本系统软件">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 7.5">起始页</a>
        </li>
      </ul>
    </div>
    <div class="sect1" lang="zh-cn" xml:lang="zh-cn">
      <h1 class="sect1">
        <a id="ch-system-adjusting" name="ch-system-adjusting"></a>6.10.
        调节工具链
      </h1>
      <p>
        现在最终的 C 库安装好了，我们应该调节工具链使得新编译的程序会链接到这些新的库。
      </p>
      <p>
        首先，备份 <code class="filename">/tools</code>
        中的链接器，并且将其替换为我们在第五章中调节过的链接器。我们还要创建一个到它在 <code class=
        "filename">/tools/$(gcc -dumpmachine)/bin</code> 中的对应的链接：
      </p>
      <pre class="userinput">
<kbd class="command">mv -v /tools/bin/{ld,ld-old}
mv -v /tools/$(gcc -dumpmachine)/bin/{ld,ld-old}
mv -v /tools/bin/{ld-new,ld}
ln -sv /tools/bin/ld /tools/$(gcc -dumpmachine)/bin/ld</kbd>
</pre>
      <p>
        下一步，修改 GCC 的 <code class="filename">specs</code>
        文件指向新的动态链接器。简单地删除所有存在的 <span class="quote">“<span class=
        "quote">/tools</span>”</span> 就可以剩下到动态链接器的正确路径。另外要使 GCC
        知道去哪里寻找正确的头文件和 Glibc 起始文件。应用一条 <span class=
        "command"><strong>sed</strong></span> 命令完成此任务：
      </p>
      <pre class="userinput">
<kbd class=
"command">gcc -dumpspecs | sed -e 's@/tools@@g'                   \
    -e '/\*startfile_prefix_spec:/{n;s@.*@/usr/lib/ @}' \
    -e '/\*cpp:/{n;s@$@ -isystem /usr/include@}' &gt;      \
    `dirname $(gcc --print-libgcc-file-name)`/specs</kbd>
</pre>
      <p>
        最好是检查一下 specs 文件确认一下要进行的改动是否真的完成了。
      </p>
      <p>
        现在很有必要检查一下调节过的工具链的基本功能 (编译和链接) 能正常工作。要如此做，进行以下稳定性检查：
      </p>
      <pre class="userinput">
<kbd class="command">echo 'main(){}' &gt; dummy.c
cc dummy.c -v -Wl,--verbose &amp;&gt; dummy.log
readelf -l a.out | grep ': /lib'</kbd>
</pre>
      <p>
        如果一切工作正常，就不应该出错，最后一条命令的输出 (允许动态链接器名称中有针对平台的差异) 应为：
      </p>
      <pre class="screen">
<code class=
"computeroutput">[Requesting program interpreter: /lib/ld-linux.so.2]</code>
</pre>
      <p>
        注意 <code class="filename">/lib</code> 现在是我们动态链接器的前缀。
      </p>
      <p>
        现在确保设置为使用正确的起始文件：
      </p>
      <pre class="userinput">
<kbd class="command">grep -o '/usr/lib.*/crt[1in].*succeeded' dummy.log</kbd>
</pre>
      <p>
        如果一切工作正常，就不应该出错，最后一条命令的输出应为：
      </p>
      <pre class="screen">
<code class="computeroutput">/usr/lib/crt1.o succeeded
/usr/lib/crti.o succeeded
/usr/lib/crtn.o succeeded</code>
</pre>
      <p>
        检查一下编译器是否寻找正确的头文件：
      </p>
      <pre class="userinput">
<kbd class="command">grep -B1 '^ /usr/include' dummy.log</kbd>
</pre>
      <p>
        此命令应该成功返回并给出以下输出：
      </p>
      <pre class="screen">
<code class="computeroutput">#include &lt;...&gt; search starts here:
 /usr/include</code>
</pre>
      <p>
        下一步检查新的链接器使用正确的搜索路径：
      </p>
      <pre class="userinput">
<kbd class="command">grep 'SEARCH.*/usr/lib' dummy.log |sed 's|; |\n|g'</kbd>
</pre>
      <p>
        如果一切工作正常，就不应该出错，最后一条命令的输出 (允许目标三联字串中有针对平台的差异) 应为：
      </p>
      <pre class="screen">
<code class="computeroutput">SEARCH_DIR("/usr/lib")
SEARCH_DIR("/lib");</code>
</pre>
      <p>
        下一步确认我们使用的是正确的 libc：
      </p>
      <pre class="userinput">
<kbd class="command">grep "/lib.*/libc.so.6 " dummy.log</kbd>
</pre>
      <p>
        如果一切工作正常，就不应该出错，最后一条命令的输出 (允许 64 位宿主上有 <code class=
        "filename">lib64</code> 目录) 应为：
      </p>
      <pre class="screen">
<code class="computeroutput">attempt to open /lib/libc.so.6 succeeded</code>
</pre>
      <p>
        最后，确保 GCC 使用正确的动态链接器：
      </p>
      <pre class="userinput">
<kbd class="command">grep found dummy.log</kbd>
</pre>
      <p>
        如果一切工作正常，就不应该出错，最后一条命令的输出 (允许动态链接器名称中有针对平台的差异、64 位宿主上有 <code class=
        "filename">lib64</code> 目录) 应为：
      </p>
      <pre class="screen">
<code class="computeroutput">found ld-linux.so.2 at /lib/ld-linux.so.2</code>
</pre>
      <p>
        如果输出不如上文所示或者根本没有输出，那么一定有某个地方严重出错了。回溯步骤，找出问题并且修正。最可能出现的原因是 specs
        文件调节出错。在进行下一步之前一定要解决所有问题。
      </p>
      <p>
        一切都正常工作之后，清理测试文件：
      </p>
      <pre class="userinput">
<kbd class="command">rm -v dummy.c a.out dummy.log</kbd>
</pre>
    </div>
    <div class="navfooter">
      <ul>
        <li class="prev">
          <a accesskey="p" href="glibc.html" title="Glibc-2.19">上一页</a>
          <p>
            Glibc-2.19
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="zlib.html" title="Zlib-1.2.8">下一页</a>
          <p>
            Zlib-1.2.8
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter06.html" title=
          "第&nbsp;6&nbsp;章&nbsp;安装基本系统软件">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 7.5">起始页</a>
        </li>
      </ul>
    </div>
  </body>
</html>
