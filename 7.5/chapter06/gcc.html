<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
    <title>
      6.17.&nbsp;GCC-4.8.2
    </title>
    <link rel="stylesheet" type="text/css" href="../stylesheets/lfs.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.78.1" />
    <link rel="stylesheet" href="stylesheets/lfs-print.css" type="text/css"
    media="print" />
  </head>
  <body class="lfs" id="lfs-7.5">
    <div class="navheader">
      <h4>
        Linux From Scratch - 版本 7.5
      </h4>
      <h3>
        第&nbsp;6&nbsp;章&nbsp;安装基本系统软件
      </h3>
      <ul>
        <li class="prev">
          <a accesskey="p" href="mpc.html" title="MPC-1.0.2">上一页</a>
          <p>
            MPC-1.0.2
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="sed.html" title="Sed-4.2.2">下一页</a>
          <p>
            Sed-4.2.2
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter06.html" title=
          "第&nbsp;6&nbsp;章&nbsp;安装基本系统软件">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 7.5">起始页</a>
        </li>
      </ul>
    </div>
    <div class="wrap" lang="zh-cn" xml:lang="zh-cn">
      <h1 class="sect1">
        <a id="ch-system-gcc" name="ch-system-gcc"></a>6.17. GCC-4.8.2
      </h1>
      <div class="package" lang="zh-cn" xml:lang="zh-cn">
        <p>
          GCC 软件包包含 GNU 编译器集，其中包括 C 和 C++ 编译器。
        </p>
        <div class="segmentedlist">
          <div class="seglistitem">
            <div class="seg">
              <strong class="segtitle">预计构建时间:</strong> <span class=
              "segbody">55.6 SBU</span>
            </div>
            <div class="seg">
              <strong class="segtitle">磁盘空间需求:</strong> <span class=
              "segbody">2.2 GB</span>
            </div>
          </div>
        </div>
      </div>
      <div class="installation" lang="zh-cn" xml:lang="zh-cn">
        <h2 class="sect2">
          6.17.1. 安装 GCC
        </h2>
        <p>
          与<a class="xref" href="../chapter05/gcc-pass2.html" title=
          "5.10.&nbsp;GCC-4.8.2 - 第 2 遍">第&nbsp;5.10&nbsp;节 “GCC-4.8.2 - 第 2
          遍”</a> 相同，应用以下 <span class="command"><strong>sed</strong></span>
          命令强制构建使用 <code class="option">-fomit-frame-pointer</code>
          编译器标记以确保编译器构建稳定：
        </p>
        <pre class="userinput">
<kbd class="command">case `uname -m` in
  i?86) sed -i 's/^T_CFLAGS =$/&amp; -fomit-frame-pointer/' gcc/Makefile.in ;;
esac</kbd>
</pre>
        <p>
          还要修复一个检验 Makefile 中的错误，并禁用 g++ libmudflap 测试套件中的一个测试：
        </p>
        <pre class="userinput">
<kbd class=
"command">sed -i -e /autogen/d -e /check.sh/d fixincludes/Makefile.in 
mv -v libmudflap/testsuite/libmudflap.c++/pass41-frag.cxx{,.disable}</kbd>
</pre>
        <p>
          GCC 文档推荐在源代码目录外另建目录构建 GCC：
        </p>
        <pre class="userinput">
<kbd class="command">mkdir -v ../gcc-build
cd ../gcc-build</kbd>
</pre>
        <p>
          准备编译 GCC：
        </p>
        <pre class="userinput">
<kbd class="command">SED=sed                          \
../gcc-4.8.2/configure           \
     --prefix=/usr               \
     --enable-shared             \
     --enable-threads=posix      \
     --enable-__cxa_atexit       \
     --enable-clocale=gnu        \
     --enable-languages=c,c++    \
     --disable-multilib          \
     --disable-bootstrap         \
     --with-system-zlib</kbd>
</pre>
        <p>
          注意对于其他语言，还有一些没有满足的前提条件。编译所有 GCC 支持语言的指令见 BLFS。
        </p>
        <div class="variablelist">
          <p class="title">
            <strong>新的配置选项的含义：</strong>
          </p>
          <dl class="variablelist">
            <dt>
              <span class="term"><code class="envar">SED=sed</code></span>
            </dt>
            <dd>
              <p>
                设置这个环境变量以避免一个到 /tools/bin/sed 的硬编码路径。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>--with-system-zlib</code></em></span>
            </dt>
            <dd>
              <p>
                此选项告诉 GCC 链接至系统上安装的 Zlib 副本而不是其内部的副本。
              </p>
            </dd>
          </dl>
        </div>
        <p>
          编译软件包：
        </p>
        <pre class="userinput">
<kbd class="command">make</kbd>
</pre>
        <div class="admon important">
          <img alt="[重要]" src="../images/important.png" />
          <h3>
            重要
          </h3>
          <p>
            本节中 GCC 的测试套件是十分重要的，任何情况下都不要跳过。
          </p>
        </div>
        <p>
          GCC 的测试套件中有一组测试已知会爆栈。在运行测试之前增大栈尺寸：
        </p>
        <pre class="userinput">
<kbd class="command">ulimit -s 32768</kbd>
</pre>
        <p>
          测试结果，但在出错时不停止：
        </p>
        <pre class="userinput">
<kbd class="command">make -k check</kbd>
</pre>
        <p>
          要获取测试套件结果的摘要，运行：
        </p>
        <pre class="userinput">
<kbd class="command">../gcc-4.8.2/contrib/test_summary</kbd>
</pre>
        <p>
          如果只要摘要，将结果以管道传送给 <strong class="userinput"><code>grep -A7
          Summ</code></strong>。
        </p>
        <p>
          可以将结果与位于 <a class="ulink" href=
          "http://www.linuxfromscratch.org/lfs/build-logs/7.5/">http://www.linuxfromscratch.org/lfs/build-logs/7.5/</a>
          和 <a class="ulink" href=
          "http://gcc.gnu.org/ml/gcc-testresults/">http://gcc.gnu.org/ml/gcc-testresults/</a>
          的样例进行比对。
        </p>
        <p>
          总是会有几个不期待的失败无法避免。GCC 开发者通常了解这些问题，但还没有解决。特别地，<code class=
          "filename">libmudflap</code> 测试已知由于 GCC 中的一个漏洞 (<a class="ulink"
          href=
          "http://gcc.gnu.org/bugzilla/show_bug.cgi?id=20003">http://gcc.gnu.org/bugzilla/show_bug.cgi?id=20003</a>)
          而特别麻烦。只要测试结果没有与以上 URL 中的相差过于悬殊，都可以安全继续。
        </p>
        <p>
          安装软件包：
        </p>
        <pre class="userinput">
<kbd class="command">make install</kbd>
</pre>
        <p>
          Some packages expect the C preprocessor to be installed in the
          <code class="filename">/lib</code> directory. To support those
          packages, create this symlink:
        </p>
        <pre class="userinput">
<kbd class="command">ln -sv ../usr/bin/cpp /lib</kbd>
</pre>
        <p>
          很多软件包使用 <span class="command"><strong>cc</strong></span> 这个名字调用 C
          编译器。要支持这些软件包，创建一个符号链接：
        </p>
        <pre class="userinput">
<kbd class="command">ln -sv gcc /usr/bin/cc</kbd>
</pre>
        <p>
          现在我们最终的工具链到位了，再次确保编译和链接正常工作就十分重要。我们要进行与本章中进行过的相同的稳定性测试：
        </p>
        <pre class="userinput">
<kbd class="command">echo 'main(){}' &gt; dummy.c
cc dummy.c -v -Wl,--verbose &amp;&gt; dummy.log
readelf -l a.out | grep ': /lib'</kbd>
</pre>
        <p>
          如果一切工作正常，就不应该出错，最后一条命令的输出 (允许动态链接器名称中有针对平台的差异) 应为：
        </p>
        <pre class="screen">
<code class=
"computeroutput">[Requesting program interpreter: /lib/ld-linux.so.2]</code>
</pre>
        <p>
          现在确保设置为使用正确的起始文件：
        </p>
        <pre class="userinput">
<kbd class="command">grep -o '/usr/lib.*/crt[1in].*succeeded' dummy.log</kbd>
</pre>
        <p>
          如果一切工作正常，就不应该出错，最后一条命令的输出应为：
        </p>
        <pre class="screen">
<code class=
"computeroutput">/usr/lib/gcc/i686-pc-linux-gnu/4.8.2/../../../crt1.o succeeded
/usr/lib/gcc/i686-pc-linux-gnu/4.8.2/../../../crti.o succeeded
/usr/lib/gcc/i686-pc-linux-gnu/4.8.2/../../../crtn.o succeeded</code>
</pre>
        <p>
          取决于你的计算机架构，以上信息可能会有轻微差异，差异通常位于 <code class=
          "filename">/usr/lib/gcc</code> 之后的目录名称。如果你的计算机是 64
          位系统，你还可能看到字符串末尾出现一个名为 <code class="filename">lib64</code>
          的目录。此处的重点是 <span class="command"><strong>gcc</strong></span> 在
          <code class="filename">/usr/lib</code> 目录中找到了全部三个 <code class=
          "filename">crt*.o</code> 文件。
        </p>
        <p>
          检查一下编译器是否寻找正确的头文件：
        </p>
        <pre class="userinput">
<kbd class="command">grep -B4 '^ /usr/include' dummy.log</kbd>
</pre>
        <p>
          此命令应该成功返回并给出以下输出：
        </p>
        <pre class="screen">
<code class="computeroutput">#include &lt;...&gt; search starts here:
 /usr/lib/gcc/i686-pc-linux-gnu/4.8.2/include
 /usr/local/include
 /usr/lib/gcc/i686-pc-linux-gnu/4.8.2/include-fixed
 /usr/include</code>
</pre>
        <p>
          再次注意，以你的目标三联字串命名的目录可能会不同。取决于你的架构。
        </p>
        <div class="admon note">
          <img alt="[注意]" src="../images/note.png" />
          <h3>
            注意
          </h3>
          <p>
            对于版本 4.3.0，GCC 现在无条件安装 <code class="filename">limits.h</code>
            文件至私有的 <code class="filename">include-fixed</code> 目录，这个目录需要到位。
          </p>
        </div>
        <p>
          下一步检查新的链接器使用正确的搜索路径：
        </p>
        <pre class="userinput">
<kbd class="command">grep 'SEARCH.*/usr/lib' dummy.log |sed 's|; |\n|g'</kbd>
</pre>
        <p>
          如果一切工作正常，就不应该出错，最后一条命令的输出 (允许目标三联字串中有针对平台的差异) 应为：
        </p>
        <pre class="screen">
<code class="computeroutput">SEARCH_DIR("/usr/i686-pc-linux-gnu/lib")
SEARCH_DIR("/usr/local/lib")
SEARCH_DIR("/lib")
SEARCH_DIR("/usr/lib");</code>
</pre>
        <p>
          64 位系统会有几个额外的目录。例如这是 x86_64 计算机的输出：
        </p>
        <pre class="screen">
<code class=
"computeroutput">SEARCH_DIR("/usr/x86_64-unknown-linux-gnu/lib64")
SEARCH_DIR("/usr/local/lib64")
SEARCH_DIR("/lib64")
SEARCH_DIR("/usr/lib64")
SEARCH_DIR("/usr/x86_64-unknown-linux-gnu/lib")
SEARCH_DIR("/usr/local/lib")
SEARCH_DIR("/lib")
SEARCH_DIR("/usr/lib");</code>
</pre>
        <p>
          下一步确认我们使用的是正确的 libc：
        </p>
        <pre class="userinput">
<kbd class="command">grep "/lib.*/libc.so.6 " dummy.log</kbd>
</pre>
        <p>
          如果一切工作正常，就不应该出错，最后一条命令的输出 (允许 64 位宿主上有 <code class=
          "filename">lib64</code> 目录) 应为：
        </p>
        <pre class="screen">
<code class="computeroutput">attempt to open /lib/libc.so.6 succeeded</code>
</pre>
        <p>
          最后，确保 GCC 使用正确的动态链接器：
        </p>
        <pre class="userinput">
<kbd class="command">grep found dummy.log</kbd>
</pre>
        <p>
          如果一切工作正常，就不应该出错，最后一条命令的输出 (允许动态链接器名称中有针对平台的差异、64 位宿主上有 <code class=
          "filename">lib64</code> 目录) 应为：
        </p>
        <pre class="screen">
<code class="computeroutput">found ld-linux.so.2 at /lib/ld-linux.so.2</code>
</pre>
        <p>
          如果输出不如上文所示或者根本没有输出，那么一定有某个地方严重出错了。回溯步骤，找出问题并且修正。最可能出现的原因是 specs
          文件调节出错。在进行下一步之前一定要解决所有问题。
        </p>
        <p>
          一切都正常工作之后，清理测试文件：
        </p>
        <pre class="userinput">
<kbd class="command">rm -v dummy.c a.out dummy.log</kbd>
</pre>
        <p>
          最后，移动一个位置不正确的文件：
        </p>
        <pre class="userinput">
<kbd class="command">mkdir -pv /usr/share/gdb/auto-load/usr/lib
mv -v /usr/lib/*gdb.py /usr/share/gdb/auto-load/usr/lib</kbd>
</pre>
      </div>
      <div class="content" lang="zh-cn" xml:lang="zh-cn">
        <h2 class="sect2">
          <a id="contents-gcc" name="contents-gcc"></a>6.17.2. GCC 的内容
        </h2>
        <div class="segmentedlist">
          <div class="seglistitem">
            <div class="seg">
              <strong class="segtitle">安装的程序:</strong> <span class=
              "segbody">c++, cc (链接到 gcc), cpp, g++, gcc, gcc-ar, gcc-nm,
              gcc-ranlib 和 gcov</span>
            </div>
            <div class="seg">
              <strong class="segtitle">安装的库:</strong> <span class=
              "segbody">libasan.{a,so}, libatomic.{a,so}, libgcc.a,
              libgcc_eh.a, libgcc_s.so, libgcov.a, libgomp.{a,so},
              libiberty.a, libitm.{a,so}, liblto_plugin.so,
              libmudflap.{a,so}, libmudflapth.{a,so}, libquadmath.{a,so},
              libssp.{a,so}, libssp_nonshared.a, libstdc++.{a,so},
              libsupc++.a 和 libtsan.{a,so}</span>
            </div>
            <div class="seg">
              <strong class="segtitle">安装的目录:</strong> <span class=
              "segbody">/usr/include/c++, /usr/lib/gcc, /usr/libexec/gcc,
              /usr/share/gcc-4.8.2</span>
            </div>
          </div>
        </div>
        <div class="variablelist">
          <h3>
            简述
          </h3>
          <table border="0" class="variablelist">
            <colgroup>
              <col align="left" valign="top" />
              <col />
            </colgroup>
            <tbody>
              <tr>
                <td>
                  <p>
                    <a id="c" name="c"></a><span class="term"><span class=
                    "command"><strong>c++</strong></span></span>
                  </p>
                </td>
                <td>
                  <p>
                    C++ 编译器
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="cc" name="cc"></a><span class="term"><span class=
                    "command"><strong>cc</strong></span></span>
                  </p>
                </td>
                <td>
                  <p>
                    C 编译器
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="cpp" name="cpp"></a><span class=
                    "term"><span class="command"><strong>cpp</strong></span></span>
                  </p>
                </td>
                <td>
                  <p>
                    C 预处理器；被编译器用于展开源文件中的 #include、#define 以及类似的类似语句
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="g" name="g"></a><span class="term"><span class=
                    "command"><strong>g++</strong></span></span>
                  </p>
                </td>
                <td>
                  <p>
                    C++ 编译器
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="gcc" name="gcc"></a><span class=
                    "term"><span class="command"><strong>gcc</strong></span></span>
                  </p>
                </td>
                <td>
                  <p>
                    C 编译器
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="gcc-ar" name="gcc-ar"></a><span class=
                    "term"><span class=
                    "command"><strong>gcc-ar</strong></span></span>
                  </p>
                </td>
                <td>
                  <p>
                    <span class="command"><strong>ar</strong></span>
                    的一个封装，在命令行中加入一个插件。此程序只用于添加 <span class=
                    "quote">“<span class=
                    "quote">链接时优化</span>”</span>，对于默认构建选项并没有什么用处
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="gcc-nm" name="gcc-nm"></a><span class=
                    "term"><span class=
                    "command"><strong>gcc-nm</strong></span></span>
                  </p>
                </td>
                <td>
                  <p>
                    <span class="command"><strong>nm</strong></span>
                    的一个封装，在命令行中加入一个插件。此程序只用于添加 <span class=
                    "quote">“<span class=
                    "quote">链接时优化</span>”</span>，对于默认构建选项并没有什么用处
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="gcc-ranlib" name="gcc-ranlib"></a><span class=
                    "term"><span class=
                    "command"><strong>gcc-ranlib</strong></span></span>
                  </p>
                </td>
                <td>
                  <p>
                    <span class="command"><strong>ranlib</strong></span>
                    的一个封装，在命令行中加入一个插件。此程序只用于添加 <span class=
                    "quote">“<span class=
                    "quote">链接时优化</span>”</span>，对于默认构建选项并没有什么用处
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="gcov" name="gcov"></a><span class=
                    "term"><span class=
                    "command"><strong>gcov</strong></span></span>
                  </p>
                </td>
                <td>
                  <p>
                    一个覆盖测试工具；用于分析程序获知优化在何处效果最好
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="libasan" name="libasan"></a><span class=
                    "term"><span class=
                    "command"><strong>libasan</strong></span></span>
                  </p>
                </td>
                <td>
                  <p>
                    地址清理器运行时库
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="libgcc" name="libgcc"></a><span class=
                    "term"><code class="filename">libgcc</code></span>
                  </p>
                </td>
                <td>
                  <p>
                    包含用于 <span class="command"><strong>gcc</strong></span>
                    的运行时支持
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="libgcov" name="libgcov"></a><span class=
                    "term"><code class="filename">libgcov</code></span>
                  </p>
                </td>
                <td>
                  <p>
                    在 GCC 获得启用分析的指令时此库链接到程序
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="libgomp" name="libgomp"></a><span class=
                    "term"><code class="filename">libgomp</code></span>
                  </p>
                </td>
                <td>
                  <p>
                    GNU 实现的多平台 OpenMP 共享内存并行编程，用于 C/C++ 和 Fortran
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="libiberty" name="libiberty"></a><span class=
                    "term"><code class="filename">libiberty</code></span>
                  </p>
                </td>
                <td>
                  <p>
                    包含被用于各种 GNU 程序，包括 <span class=
                    "command"><strong>getopt</strong></span>，<span class=
                    "command"><strong>obstack</strong></span>，<span class=
                    "command"><strong>strerror</strong></span>，<span class=
                    "command"><strong>strtol</strong></span> 和 <span class=
                    "command"><strong>strtoul</strong></span> 的套件
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="liblto_plugin" name=
                    "liblto_plugin"></a><span class="term"><code class=
                    "filename">liblto_plugin</code></span>
                  </p>
                </td>
                <td>
                  <p>
                    GCC 的链接时优化插件，允许 GCC 在多个编译单元之间进行优化
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="libmudflap" name="libmudflap"></a><span class=
                    "term"><code class="filename">libmudflap</code></span>
                  </p>
                </td>
                <td>
                  <p>
                    包含支持 GCC 的边界检查功能的途径
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="libquadmath" name="libquadmath"></a><span class=
                    "term"><code class="filename">libquadmath</code></span>
                  </p>
                </td>
                <td>
                  <p>
                    GCC 四精度数学库 API
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="libssp" name="libssp"></a><span class=
                    "term"><code class="filename">libssp</code></span>
                  </p>
                </td>
                <td>
                  <p>
                    包含支持 GCC 防爆栈保护功能的套件
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="libstdc" name="libstdc"></a><span class=
                    "term"><code class="filename">libstdc++</code></span>
                  </p>
                </td>
                <td>
                  <p>
                    标准 C++ 库
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="libsupc" name="libsupc"></a><span class=
                    "term"><code class="filename">libsupc++</code></span>
                  </p>
                </td>
                <td>
                  <p>
                    为 C++ 程序设计语言提供支持的套件
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="libtsan" name="libtsan"></a><span class=
                    "term"><code class="filename">libtsan</code></span>
                  </p>
                </td>
                <td>
                  <p>
                    线程清理器运行时库
                  </p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="navfooter">
      <ul>
        <li class="prev">
          <a accesskey="p" href="mpc.html" title="MPC-1.0.2">上一页</a>
          <p>
            MPC-1.0.2
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="sed.html" title="Sed-4.2.2">下一页</a>
          <p>
            Sed-4.2.2
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter06.html" title=
          "第&nbsp;6&nbsp;章&nbsp;安装基本系统软件">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 7.5">起始页</a>
        </li>
      </ul>
    </div>
  </body>
</html>
