<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
    <title>
      5.10.&nbsp;GCC-4.8.2 - Pass 2
    </title>
    <link rel="stylesheet" type="text/css" href="../stylesheets/lfs.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.78.1" />
    <link rel="stylesheet" href="stylesheets/lfs-print.css" type="text/css"
    media="print" />
  </head>
  <body class="lfs" id="lfs-7.5">
    <div class="navheader">
      <h4>
        Linux From Scratch - 版本 7.5
      </h4>
      <h3>
        第&nbsp;5&nbsp;章&nbsp;构建一个临时系统
      </h3>
      <ul>
        <li class="prev">
          <a accesskey="p" href="binutils-pass2.html" title=
          "Binutils-2.24 - Pass 2">上一页</a>
          <p>
            Binutils-2.24 - Pass 2
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="tcl.html" title="Tcl-8.6.1">下一页</a>
          <p>
            Tcl-8.6.1
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter05.html" title=
          "第&nbsp;5&nbsp;章&nbsp;构建一个临时系统">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 7.5">起始页</a>
        </li>
      </ul>
    </div>
    <div class="wrap" lang="zh-cn" xml:lang="zh-cn">
      <h1 class="sect1">
        <a id="ch-tools-gcc-pass2" name="ch-tools-gcc-pass2"></a>5.10.
        GCC-4.8.2 - Pass 2
      </h1>
      <div class="package" lang="zh-cn" xml:lang="zh-cn">
        <p>
          The GCC package contains the GNU compiler collection, which
          includes the C and C++ compilers.
        </p>
        <div class="segmentedlist">
          <div class="seglistitem">
            <div class="seg">
              <strong class="segtitle">预计编译时间:</strong> <span class=
              "segbody">7.1 SBU</span>
            </div>
            <div class="seg">
              <strong class="segtitle">空间需求:</strong> <span class=
              "segbody">1.8 GB</span>
            </div>
          </div>
        </div>
      </div>
      <div class="installation" lang="zh-cn" xml:lang="zh-cn">
        <h2 class="sect2">
          5.10.1. Installation of GCC
        </h2>
        <p>
          Our first build of GCC has installed a couple of internal system
          headers. Normally one of them, <code class=
          "filename">limits.h</code> will in turn include the corresponding
          system <code class="filename">limits.h</code> header, in this case,
          <code class="filename">/tools/include/limits.h</code>. However, at
          the time of the first build of gcc <code class=
          "filename">/tools/include/limits.h</code> did not exist, so the
          internal header that GCC installed is a partial, self-contained
          file and does not include the extended features of the system
          header. This was adequate for building the temporary libc, but this
          build of GCC now requires the full internal header. Create a full
          version of the internal header using a command that is identical to
          what the GCC build system does in normal circumstances:
        </p>
        <pre class="userinput">
<kbd class="command">cat gcc/limitx.h gcc/glimits.h gcc/limity.h &gt; \
  `dirname $($LFS_TGT-gcc -print-libgcc-file-name)`/include-fixed/limits.h</kbd>
</pre>
        <p>
          For x86 machines, a bootstrap build of GCC uses the <code class=
          "option">-fomit-frame-pointer</code> compiler flag. Non-bootstrap
          builds omit this flag by default, and the goal should be to produce
          a compiler that is exactly the same as if it were bootstrapped.
          Apply the following <span class=
          "command"><strong>sed</strong></span> command to force the build to
          use the flag:
        </p>
        <pre class="userinput">
<kbd class="command">case `uname -m` in
  i?86) sed -i 's/^T_CFLAGS =$/&amp; -fomit-frame-pointer/' gcc/Makefile.in ;;
esac</kbd>
</pre>
        <p>
          Once again, change the location of GCC's default dynamic linker to
          use the one installed in <code class="filename">/tools</code>.
        </p>
        <pre class="userinput">
<kbd class="command">for file in \
 $(find gcc/config -name linux64.h -o -name linux.h -o -name sysv4.h)
do
  cp -uv $file{,.orig}
  sed -e 's@/lib\(64\)\?\(32\)\?/ld@/tools&amp;@g' \
      -e 's@/usr@/tools@g' $file.orig &gt; $file
  echo '
#undef STANDARD_STARTFILE_PREFIX_1
#undef STANDARD_STARTFILE_PREFIX_2
#define STANDARD_STARTFILE_PREFIX_1 "/tools/lib/"
#define STANDARD_STARTFILE_PREFIX_2 ""' &gt;&gt; $file
  touch $file.orig
done</kbd>
</pre>
        <p>
          As in the first build of GCC it requires the GMP, MPFR and MPC
          packages. Unpack the tarballs and move them into the required
          directory names:
        </p>
        <pre class="userinput">
<kbd class="command">tar -Jxf ../mpfr-3.1.2.tar.xz
mv -v mpfr-3.1.2 mpfr
tar -Jxf ../gmp-5.1.3.tar.xz
mv -v gmp-5.1.3 gmp
tar -zxf ../mpc-1.0.2.tar.gz
mv -v mpc-1.0.2 mpc</kbd>
</pre>
        <p>
          Create a separate build directory again:
        </p>
        <pre class="userinput">
<kbd class="command">mkdir -v ../gcc-build
cd ../gcc-build</kbd>
</pre>
        <p>
          Before starting to build GCC, remember to unset any environment
          variables that override the default optimization flags.
        </p>
        <p>
          Now prepare GCC for compilation:
        </p>
        <pre class="userinput">
<kbd class="command">CC=$LFS_TGT-gcc                                      \
CXX=$LFS_TGT-g++                                     \
AR=$LFS_TGT-ar                                       \
RANLIB=$LFS_TGT-ranlib                               \
../gcc-4.8.2/configure                               \
    --prefix=/tools                                  \
    --with-local-prefix=/tools                       \
    --with-native-system-header-dir=/tools/include   \
    --enable-clocale=gnu                             \
    --enable-shared                                  \
    --enable-threads=posix                           \
    --enable-__cxa_atexit                            \
    --enable-languages=c,c++                         \
    --disable-libstdcxx-pch                          \
    --disable-multilib                               \
    --disable-bootstrap                              \
    --disable-libgomp                                \
    --with-mpfr-include=$(pwd)/../gcc-4.8.2/mpfr/src \
    --with-mpfr-lib=$(pwd)/mpfr/src/.libs</kbd>
</pre>
        <div class="variablelist">
          <p class="title">
            <strong>The meaning of the new configure options:</strong>
          </p>
          <dl class="variablelist">
            <dt>
              <span class="term"><em class=
              "parameter"><code>--enable-clocale=gnu</code></em></span>
            </dt>
            <dd>
              <p>
                This option ensures the correct locale model is selected for
                the C++ libraries under all circumstances. If the configure
                script finds the <span class="emphasis"><em>de_DE</em></span>
                locale installed, it will select the correct gnu locale
                model. However, if the <span class=
                "emphasis"><em>de_DE</em></span> locale is not installed,
                there is the risk of building Application Binary Interface
                (ABI)-incompatible C++ libraries because the incorrect
                generic locale model may be selected.
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>--enable-threads=posix</code></em></span>
            </dt>
            <dd>
              <p>
                This enables C++ exception handling for multi-threaded code.
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>--enable-__cxa_atexit</code></em></span>
            </dt>
            <dd>
              <p>
                This option allows use of <code class=
                "function">__cxa_atexit</code>, rather than <code class=
                "function">atexit</code>, to register C++ destructors for
                local statics and global objects. This option is essential
                for fully standards-compliant handling of destructors. It
                also affects the C++ ABI, and therefore results in C++ shared
                libraries and C++ programs that are interoperable with other
                Linux distributions.
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>--enable-languages=c,c++</code></em></span>
            </dt>
            <dd>
              <p>
                This option ensures that both the C and C++ compilers are
                built.
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>--disable-libstdcxx-pch</code></em></span>
            </dt>
            <dd>
              <p>
                Do not build the pre-compiled header (PCH) for <code class=
                "filename">libstdc++</code>. It takes up a lot of space, and
                we have no use for it.
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>--disable-bootstrap</code></em></span>
            </dt>
            <dd>
              <p>
                For native builds of GCC, the default is to do a "bootstrap"
                build. This does not just compile GCC, but compiles it
                several times. It uses the programs compiled in a first round
                to compile itself a second time, and then again a third time.
                The second and third iterations are compared to make sure it
                can reproduce itself flawlessly. This also implies that it
                was compiled correctly. However, the LFS build method should
                provide a solid compiler without the need to bootstrap each
                time.
              </p>
            </dd>
          </dl>
        </div>
        <p>
          Compile the package:
        </p>
        <pre class="userinput">
<kbd class="command">make</kbd>
</pre>
        <p>
          Install the package:
        </p>
        <pre class="userinput">
<kbd class="command">make install</kbd>
</pre>
        <p>
          As a finishing touch, create a symlink. Many programs and scripts
          run <span class="command"><strong>cc</strong></span> instead of
          <span class="command"><strong>gcc</strong></span>, which is used to
          keep programs generic and therefore usable on all kinds of UNIX
          systems where the GNU C compiler is not always installed. Running
          <span class="command"><strong>cc</strong></span> leaves the system
          administrator free to decide which C compiler to install:
        </p>
        <pre class="userinput">
<kbd class="command">ln -sv gcc /tools/bin/cc</kbd>
</pre>
        <div class="admon caution">
          <img alt="[小心]" src="../images/caution.png" />
          <h3>
            小心
          </h3>
          <p>
            At this point, it is imperative to stop and ensure that the basic
            functions (compiling and linking) of the new toolchain are
            working as expected. To perform a sanity check, run the following
            commands:
          </p>
          <pre class="userinput">
<kbd class="command">echo 'main(){}' &gt; dummy.c
cc dummy.c
readelf -l a.out | grep ': /tools'</kbd>
</pre>
          <p>
            If everything is working correctly, there should be no errors,
            and the output of the last command will be of the form:
          </p>
          <pre class="screen">
<code class=
"computeroutput">[Requesting program interpreter: /tools/lib/ld-linux.so.2]</code>
</pre>
          <p>
            Note that <code class="filename">/tools/lib</code>, or
            <code class="filename">/tools/lib64</code> for 64-bit machines
            appears as the prefix of the dynamic linker.
          </p>
          <p>
            If the output is not shown as above or there was no output at
            all, then something is wrong. Investigate and retrace the steps
            to find out where the problem is and correct it. This issue must
            be resolved before continuing on. First, perform the sanity check
            again, using <span class="command"><strong>gcc</strong></span>
            instead of <span class="command"><strong>cc</strong></span>. If
            this works, then the <code class="filename">/tools/bin/cc</code>
            symlink is missing. Install the symlink as per above. Next,
            ensure that the <code class="envar">PATH</code> is correct. This
            can be checked by running <span class="command"><strong>echo
            $PATH</strong></span> and verifying that <code class=
            "filename">/tools/bin</code> is at the head of the list. If the
            <code class="envar">PATH</code> is wrong it could mean that you
            are not logged in as user <code class="systemitem">lfs</code> or
            that something went wrong back in <a class="xref" href=
            "../chapter04/settingenvironment.html" title=
            "4.4.&nbsp;设置工作环境">第&nbsp;4.4&nbsp;节 “设置工作环境.”</a>
          </p>
          <p>
            Once all is well, clean up the test files:
          </p>
          <pre class="userinput">
<kbd class="command">rm -v dummy.c a.out</kbd>
</pre>
        </div>
      </div>
      <div class="content" lang="zh-cn" xml:lang="zh-cn">
        <p>
          Details on this package are located in <a class="xref" href=
          "../chapter06/gcc.html#contents-gcc" title=
          "6.17.2.&nbsp;Contents of GCC">第&nbsp;6.17.2&nbsp;节 “Contents of
          GCC.”</a>
        </p>
      </div>
    </div>
    <div class="navfooter">
      <ul>
        <li class="prev">
          <a accesskey="p" href="binutils-pass2.html" title=
          "Binutils-2.24 - Pass 2">上一页</a>
          <p>
            Binutils-2.24 - Pass 2
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="tcl.html" title="Tcl-8.6.1">下一页</a>
          <p>
            Tcl-8.6.1
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter05.html" title=
          "第&nbsp;5&nbsp;章&nbsp;构建一个临时系统">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 7.5">起始页</a>
        </li>
      </ul>
    </div>
  </body>
</html>
