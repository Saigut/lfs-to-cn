<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
    <title>
      5.5.&nbsp;GCC-4.8.2 - 第 1 遍
    </title>
    <link rel="stylesheet" type="text/css" href="../stylesheets/lfs.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.78.1" />
    <link rel="stylesheet" href="stylesheets/lfs-print.css" type="text/css"
    media="print" />
  </head>
  <body class="lfs" id="lfs-7.5">
    <div class="navheader">
      <h4>
        Linux From Scratch - 版本 7.5
      </h4>
      <h3>
        第&nbsp;5&nbsp;章&nbsp;构建一个临时系统
      </h3>
      <ul>
        <li class="prev">
          <a accesskey="p" href="binutils-pass1.html" title=
          "Binutils-2.24 - Pass 1">上一页</a>
          <p>
            Binutils-2.24 - Pass 1
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="linux-headers.html" title=
          "Linux-3.13.3 API Headers">下一页</a>
          <p>
            Linux-3.13.3 API Headers
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter05.html" title=
          "第&nbsp;5&nbsp;章&nbsp;构建一个临时系统">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 7.5">起始页</a>
        </li>
      </ul>
    </div>
    <div class="wrap" lang="zh-cn" xml:lang="zh-cn">
      <h1 class="sect1">
        <a id="ch-tools-gcc-pass1" name="ch-tools-gcc-pass1"></a>5.5.
        GCC-4.8.2 - 第 1 遍
      </h1>
      <div class="package" lang="zh-cn" xml:lang="zh-cn">
        <p>
          The GCC package contains the GNU compiler collection, which
          includes the C and C++ compilers.
        </p>
        <div class="segmentedlist">
          <div class="seglistitem">
            <div class="seg">
              <strong class="segtitle">预计编译时间:</strong> <span class=
              "segbody">5.5 SBU</span>
            </div>
            <div class="seg">
              <strong class="segtitle">空间需求:</strong> <span class=
              "segbody">1.4 GB</span>
            </div>
          </div>
        </div>
      </div>
      <div class="installation" lang="zh-cn" xml:lang="zh-cn">
        <h2 class="sect2">
          5.5.1. 交叉 GCC 的安装
        </h2>
        <p>
          GCC 现在需要 GMP，MPFR 和 MPC 软件包。由于你的宿主发行版可能没有这些软件，所谓它们会和 GCC
          一起被构建。把每个包都解压至 GCC 源代码目录，并把解出的目录重命名，让 GCC 构建过程能够自动使用它们：
        </p>
        <div class="admon note">
          <img alt="[注意]" src="../images/note.png" />
          <h3>
            注意
          </h3>
          <p>
            关于这一章经常会有一些误解。这里的步骤和前面的每一章都一样（<a class="xref" href=
            "generalinstructions.html#buildinstr">Package build
            instructions</a>）。首先从 sources 目录中解压 gcc
            包，然后进入解压出的目录。只有这样然后你才应该继续下面的指令。
          </p>
        </div>
        <pre class="userinput">
<kbd class="command">tar -Jxf ../mpfr-3.1.2.tar.xz
mv -v mpfr-3.1.2 mpfr
tar -Jxf ../gmp-5.1.3.tar.xz
mv -v gmp-5.1.3 gmp
tar -zxf ../mpc-1.0.2.tar.gz
mv -v mpc-1.0.2 mpc</kbd>
</pre>
        <p>
          下面的命令会改变 GCC 的默认链接器的位置，以使用安装在 <code class="filename">/tools</code>
          中的链接器。它也把 <code class="filename">/usr/include</code> 从 GCC 的
          include 搜索路径中移除。执行：
        </p>
        <pre class="userinput">
<kbd class="command">for file in \
 $(find gcc/config -name linux64.h -o -name linux.h -o -name sysv4.h)
do
  cp -uv $file{,.orig}
  sed -e 's@/lib\(64\)\?\(32\)\?/ld@/tools&amp;@g' \
      -e 's@/usr@/tools@g' $file.orig &gt; $file
  echo '
#undef STANDARD_STARTFILE_PREFIX_1
#undef STANDARD_STARTFILE_PREFIX_2
#define STANDARD_STARTFILE_PREFIX_1 "/tools/lib/"
#define STANDARD_STARTFILE_PREFIX_2 ""' &gt;&gt; $file
  touch $file.orig
done</kbd>
</pre>
        <p>
          如果上述命令看起来费解的话，让我们来分解它来看。首先我们找到 <code class=
          "filename">gcc/config</code> 目录中所有名为 <code class=
          "filename">linux.h</code> 或 <code class="filename">linux64.h</code>
          或 <code class="filename">sysv4.h</code> 的文件。我们把找到的每一个文件都复制到一个同名但增加了
          <span class="quote">“<span class="quote">.orig</span>”</span>
          后缀的文件。 然后第一个 sed 表达式在每一个 <span class="quote">“<span class=
          "quote">/lib/ld</span>”</span>，<span class="quote">“<span class=
          "quote">/lib64/ld</span>”</span> 或<span class="quote">“<span class=
          "quote">/lib32/ld</span>”</span> 前面加上 <span class=
          "quote">“<span class="quote">/tools</span>”</span>，第二个替换硬编码的
          <span class="quote">“<span class=
          "quote">/usr</span>”</span>。接下来我们把我们的 define
          语句加到文件的最后，这些语句会改变默认起始文件前缀。注意 <span class="quote">“<span class=
          "quote">/tools/lib/</span>”</span> 尾部的 <span class=
          "quote">“<span class="quote">/</span>”</span> 是要带着的。最后，我们用
          <span class="command"><strong>touch</strong></span>
          来更新复制后的文件的时间戳。在与 <span class="command"><strong>cp
          -u</strong></span> 命令一起使用时，会避免万一命令不经意运行了两次而对原文件造成意外的更改。
        </p>
        <p>
          GCC 不能正确检测堆保护，这会导致 Glibc-2.19 的构建出现问题，所以请执行下面的命令修复：
        </p>
        <pre class="userinput">
<kbd class=
"command">sed -i '/k prot/agcc_cv_libc_provides_ssp=yes' gcc/configure</kbd>
</pre>
        <p>
          GCC 文档建议在源代码目录外面的一个专用构建目录中构建 GCC：
        </p>
        <pre class="userinput">
<kbd class="command">mkdir -v ../gcc-build
cd ../gcc-build</kbd>
</pre>
        <p>
          准备编译 GCC：
        </p>
        <pre class="userinput">
<kbd class="command">../gcc-4.8.2/configure                               \
    --target=$LFS_TGT                                \
    --prefix=/tools                                  \
    --with-sysroot=$LFS                              \
    --with-newlib                                    \
    --without-headers                                \
    --with-local-prefix=/tools                       \
    --with-native-system-header-dir=/tools/include   \
    --disable-nls                                    \
    --disable-shared                                 \
    --disable-multilib                               \
    --disable-decimal-float                          \
    --disable-threads                                \
    --disable-libatomic                              \
    --disable-libgomp                                \
    --disable-libitm                                 \
    --disable-libmudflap                             \
    --disable-libquadmath                            \
    --disable-libsanitizer                           \
    --disable-libssp                                 \
    --disable-libstdc++-v3                           \
    --enable-languages=c,c++                         \
    --with-mpfr-include=$(pwd)/../gcc-4.8.2/mpfr/src \
    --with-mpfr-lib=$(pwd)/mpfr/src/.libs</kbd>
</pre>
        <div class="variablelist">
          <p class="title">
            <strong>configure 选项的含义：</strong>
          </p>
          <dl class="variablelist">
            <dt>
              <span class="term"><em class=
              "parameter"><code>--with-newlib</code></em></span>
            </dt>
            <dd>
              <p>
                由于现在 C 库还不可用，此项确保了在构建 libgcc 时 inhibit_libc 常量已被定义。这避免了任何需要
                libc 支持的代码的编译。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>--without-headers</code></em></span>
            </dt>
            <dd>
              <p>
                当创建一个完整的交叉编译器的时候，GCC 需要兼容于目标系统的标准头文件。对于我们的目的，这些头文件是不需要的。此项避免
                GCC 寻找它们。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>--with-local-prefix=/tools</code></em></span>
            </dt>
            <dd>
              <p>
                本地前缀是 GCC 在系统中寻找本地安装的 include 文件的位置。默认位置是 <code class=
                "filename">/usr/local</code>。把这个设为 <code class=
                "filename">/tools</code> 使宿主的 <code class=
                "filename">/usr/local</code> 位置在 GCC 搜索路径的外面。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>--with-native-system-header-dir=/tools/include</code></em></span>
            </dt>
            <dd>
              <p>
                GCC 默认在 <code class="filename">/usr/include</code>
                中查找系统头文件。这和 sysroot 选项一起，会把这个位置翻译为 <code class=
                "filename">$LFS/usr/include</code>。然而后面两节将会把头文件安装到
                <code class="filename">$LFS/tools/include</code>。这个选项确保 gcc
                能够正确地找到它们。在 GCC 的第 2 遍中，这个相同的选项会确保不从宿主系统中寻找头文件。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>--disable-shared</code></em></span>
            </dt>
            <dd>
              <p>
                这个选项强制 GCC 静态链接它的内部库。我们这样做是为了避免可能出现与宿主系统有关的问题。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>--disable-decimal-float, --disable-threads,
              --disable-libatomic, --disable-libgomp, --disable-libitm,
              --disable-libmudflap, --disable-libquadmath,
              --disable-libsanitizer, --disable-libssp,
              --disable-libstdc++-v3</code></em></span>
            </dt>
            <dd>
              <p>
                这些选项分别禁用了十进制浮点扩展、线程、libatomic、libgomp、libitm、libmudflap、libquadmath、libsanitizer、libssp
                和 C++ 标准库的支持。这些特性在构建一个交叉编译器时会编译失败，而且对于交叉编译临时 libc 也不需要。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>--disable-multilib</code></em></span>
            </dt>
            <dd>
              <p>
                在 x86_64 上，LFS 还不支持多库配置。这个选项对 x86 无害。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>--enable-languages=c,c++</code></em></span>
            </dt>
            <dd>
              <p>
                这个选项确保只有 C 和 C++ 编译器被构建。这些是目前仅需要的语言。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>--with-mpfr-*</code></em></span>
            </dt>
            <dd>
              <p>
                这些选项使构建的系统能正确地使用 MPFR 源文件的 in-tree 拷贝。
              </p>
            </dd>
          </dl>
        </div>
        <p>
          运行以下命令编译 GCC：
        </p>
        <pre class="userinput">
<kbd class="command">make</kbd>
</pre>
        <p>
          编译现在完成了。此时，通常要运行测试套件，但正如我们前面提到的，测试套件的框架还没有就位。此时运行测试的的好处很小，因为第 1
          遍安装的程序不久会被替换掉。
        </p>
        <p>
          安装软件包:
        </p>
        <pre class="userinput">
<kbd class="command">make install</kbd>
</pre>
        <p>
          使用 <em class="parameter"><code>--disable-shared</code></em> 意味着
          <code class="filename">libgcc_eh.a</code> 文件不会被创建和安装。而Glibc
          包依赖这个库，因为在它的构建系统中使用了 <em class=
          "parameter"><code>-lgcc_eh</code></em>。这个依赖关系可以通过创建一个到 <code class=
          "filename">libgcc.a</code> 的符号链接来满足，因为这个文件最终会包含 <code class=
          "filename">libgcc_eh.a</code> 文件中包含的部件：
        </p>
        <pre class="userinput">
<kbd class=
"command">ln -sv libgcc.a `$LFS_TGT-gcc -print-libgcc-file-name | sed 's/libgcc/&amp;_eh/'`</kbd>
</pre>
      </div>
      <div class="content" lang="zh-cn" xml:lang="zh-cn">
        <p>
          这个包的详细信息位于 <a class="xref" href=
          "../chapter06/gcc.html#contents-gcc" title=
          "6.17.2.&nbsp;Contents of GCC">第&nbsp;6.17.2&nbsp;节 “Contents of
          GCC.”</a>。
        </p>
      </div>
    </div>
    <div class="navfooter">
      <ul>
        <li class="prev">
          <a accesskey="p" href="binutils-pass1.html" title=
          "Binutils-2.24 - Pass 1">上一页</a>
          <p>
            Binutils-2.24 - Pass 1
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="linux-headers.html" title=
          "Linux-3.13.3 API Headers">下一页</a>
          <p>
            Linux-3.13.3 API Headers
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter05.html" title=
          "第&nbsp;5&nbsp;章&nbsp;构建一个临时系统">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 7.5">起始页</a>
        </li>
      </ul>
    </div>
  </body>
</html>
